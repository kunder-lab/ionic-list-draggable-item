/*!
 * Copyright 2016 kunder
 * http://kunder.cl/
 *
 * Ionic List Draggable Item , v1.0.0
 * Custom implementation of ionic list to support draggable items without pressing "order" button
 * https://github.com/kunder-lab/ionic-list-draggable-item
 *
 * By @arturokunder
 *
 * Licensed under the MIT license. Please see LICENSE for more information.
 *
 */

!function(e){"use strict";var t="item",r="item-content",i="item-sliding",n="item-options",s="item-placeholder",l="item-reordering",o="item-reorder",a=function(e){};a.prototype={holdTimeout:null,holdedItem:null},a.prototype.startTimer=function(){var e=this;e.holdTimeout=c(e)},a.prototype.clearTimer=function(){var e=this;e.holdTimeout&&null!==e.holdTimeout&&(clearTimeout(e.holdTimeout),e.holdTimeout=null)};var c=function(e){return setTimeout(function(){e.holdedItem.holded=!1},1e3)},u=function(){};u.prototype={start:function(){},drag:function(){},end:function(){},isSameItem:function(){return!1}};var g=function(e){this.dragThresholdX=e.dragThresholdX||10,this.el=e.el,this.item=e.item,this.canSwipe=e.canSwipe};g.prototype=new u,g.prototype.start=function(s){var l,o,a,c;this.canSwipe()&&(l=s.target.classList.contains(r)?s.target:s.target.classList.contains(t)?s.target.querySelector("."+r):e.DomUtil.getParentWithClass(s.target,r),l&&(l.classList.remove(i),a=parseFloat(l.style[e.CSS.TRANSFORM].replace("translate3d(","").split(",")[0])||0,o=l.parentNode.querySelector("."+n),o&&(o.classList.remove("invisible"),c=o.offsetWidth,this._currentDrag={buttons:o,buttonsWidth:c,content:l,startOffsetX:a})))},g.prototype.isSameItem=function(e){return e._lastDrag&&this._currentDrag?this._currentDrag.content==e._lastDrag.content:!1},g.prototype.clean=function(t){function r(){i.buttons&&i.buttons.classList.add("invisible")}var i=this._lastDrag;i&&i.content&&(i.content.style[e.CSS.TRANSITION]="",i.content.style[e.CSS.TRANSFORM]="",t?(i.content.style[e.CSS.TRANSITION]="none",r(),e.requestAnimationFrame(function(){i.content.style[e.CSS.TRANSITION]=""})):e.requestAnimationFrame(function(){setTimeout(r,250)}))},g.prototype.drag=e.animationFrameThrottle(function(t){var r;if(this._currentDrag&&(!this._isDragging&&(Math.abs(t.gesture.deltaX)>this.dragThresholdX||Math.abs(this._currentDrag.startOffsetX)>0)&&(this._isDragging=!0),this._isDragging)){r=this._currentDrag.buttonsWidth;var i=Math.min(0,this._currentDrag.startOffsetX+t.gesture.deltaX);-r>i&&(i=Math.min(-r,-r+.4*(t.gesture.deltaX+r))),this._currentDrag.content.$$ionicOptionsOpen=0!==i,this._currentDrag.content.style[e.CSS.TRANSFORM]="translate3d("+i+"px, 0, 0)",this._currentDrag.content.style[e.CSS.TRANSITION]="none"}}),g.prototype.end=function(t,r){var i=this;if(!i._currentDrag)return void(r&&r());var n=-i._currentDrag.buttonsWidth;t.gesture.deltaX>-(i._currentDrag.buttonsWidth/2)&&("left"==t.gesture.direction&&Math.abs(t.gesture.velocityX)<.3?n=0:"right"==t.gesture.direction&&(n=0)),e.requestAnimationFrame(function(){if(0===n){i._currentDrag.content.style[e.CSS.TRANSFORM]="";var t=i._currentDrag.buttons;setTimeout(function(){t&&t.classList.add("invisible")},250)}else i._currentDrag.content.style[e.CSS.TRANSFORM]="translate3d("+n+"px,0,0)";i._currentDrag.content.style[e.CSS.TRANSITION]="",i._lastDrag||(i._lastDrag={}),e.extend(i._lastDrag,i._currentDrag),i._currentDrag&&(i._currentDrag.buttons=null,i._currentDrag.content=null),i._currentDrag=null,r&&r()})};var d=function(e){var t=this;if(t.dragThresholdY=e.dragThresholdY||0,t.onReorder=e.onReorder,t.listEl=e.listEl,t.el=t.item=e.el,t.scrollEl=e.scrollEl,t.scrollView=e.scrollView,t.listElTrueTop=0,t.listEl.offsetParent){var r=t.listEl;do t.listElTrueTop+=r.offsetTop,r=r.offsetParent;while(r)}};d.prototype=new u,d.prototype._moveElement=function(t){var r=t.gesture.center.pageY+this.scrollView.getValues().top-this._currentDrag.elementHeight/2-this.listElTrueTop;this.el.style[e.CSS.TRANSFORM]="translate3d(0, "+r+"px, 0)"},d.prototype.deregister=function(){this.listEl=this.el=this.scrollEl=this.scrollView=null},d.prototype.start=function(t){var r=e.DomUtil.getChildIndex(this.el,this.el.nodeName.toLowerCase()),i=this.el.scrollHeight,n=this.el.cloneNode(!0);n.classList.add(s),this.el.parentNode.insertBefore(n,this.el),this.el.classList.add(l),this._currentDrag={elementHeight:i,startIndex:r,placeholder:n,scrollHeight:scroll,list:n.parentNode},this._moveElement(t)},d.prototype.drag=e.animationFrameThrottle(function(t){var r=this;if(this._currentDrag){var i=0,n=t.gesture.center.pageY,s=this.listElTrueTop;if(this.scrollView){var l=this.scrollView.__container;i=this.scrollView.getValues().top;var o=l.offsetTop,a=o-n+this._currentDrag.elementHeight/2,c=n+this._currentDrag.elementHeight/2-o-l.offsetHeight;t.gesture.deltaY<0&&a>0&&i>0&&(this.scrollView.scrollBy(null,-a),e.requestAnimationFrame(function(){r.drag(t)})),t.gesture.deltaY>0&&c>0&&i<this.scrollView.getScrollMax().top&&(this.scrollView.scrollBy(null,c),e.requestAnimationFrame(function(){r.drag(t)}))}!this._isDragging&&Math.abs(t.gesture.deltaY)>this.dragThresholdY&&(this._isDragging=!0),this._isDragging&&(this._moveElement(t),this._currentDrag.currentY=i+n-s)}}),d.prototype._getReorderIndex=function(){for(var e,t=this,r=Array.prototype.slice.call(t._currentDrag.placeholder.parentNode.children).filter(function(e){return e.nodeName===t.el.nodeName&&e!==t.el}),i=t._currentDrag.currentY,n=0,s=r.length;s>n;n++)if(e=r[n],n===s-1){if(i>e.offsetTop)return n}else if(0===n){if(i<e.offsetTop+e.offsetHeight)return n}else if(i>e.offsetTop-e.offsetHeight/2&&i<e.offsetTop+e.offsetHeight)return n;return t._currentDrag.startIndex},d.prototype.end=function(t,r){if(!this._currentDrag)return void(r&&r());var i=this._currentDrag.placeholder,n=this._getReorderIndex();this.el.classList.remove(l),this.el.style[e.CSS.TRANSFORM]="",i.parentNode.insertBefore(this.el,i),i.parentNode.removeChild(i),this.onReorder&&this.onReorder(this.el,this._currentDrag.startIndex,n),this._currentDrag={placeholder:null,content:null},this._currentDrag=null,r&&r()},e.views.DraggableItemListView=e.views.View.inherit({initialize:function(t){var r=this;t=e.extend({onReorder:function(){},virtualRemoveThreshold:-200,virtualAddThreshold:200,canSwipe:function(){return!0}},t),e.extend(r,t),!r.itemHeight&&r.listEl&&(r.itemHeight=r.listEl.children[0]&&parseInt(r.listEl.children[0].style.height,10)),r.onRefresh=t.onRefresh||function(){},r.onRefreshOpening=t.onRefreshOpening||function(){},r.onRefreshHolding=t.onRefreshHolding||function(){};var i={};e.DomUtil.getParentOrSelfWithClass(r.el,"overflow-scroll")&&(i.prevent_default_directions=["left","right"]),window.ionic.onGesture("hold",function(e){r._handleHold(e)},r.el,i),window.ionic.onGesture("release",function(e){r._handleEndDrag(e)},r.el,i),window.ionic.onGesture("drag",function(e){r._handleDrag(e)},r.el,i),r._initDrag(),r._initHold()},deregister:function(){this.el=this.listEl=this.scrollEl=this.scrollView=null,this.isScrollFreeze&&self.scrollView.freeze(!1)},stopRefreshing:function(){var e=this.el.querySelector(".list-refresher");e.style.height="0"},didScroll:function(e){var t=this;if(t.isVirtual){var r=t.itemHeight,i=e.target.scrollHeight,n=t.el.parentNode.offsetHeight,s=Math.max(0,e.scrollTop+t.virtualRemoveThreshold),l=Math.min(i,Math.abs(e.scrollTop)+n+t.virtualAddThreshold),o=parseInt(Math.abs(s/r),10),a=parseInt(Math.abs(l/r),10);t._virtualItemsToRemove=Array.prototype.slice.call(t.listEl.children,0,o),t.renderViewport&&t.renderViewport(s,l,o,a)}},didStopScrolling:function(){if(this.isVirtual)for(var e=0;e<this._virtualItemsToRemove.length;e++)this.didHideItem&&this.didHideItem(e)},clearDragEffects:function(e){this._lastDragOp&&(this._lastDragOp.clean&&this._lastDragOp.clean(e),this._lastDragOp.deregister&&this._lastDragOp.deregister(),this._lastDragOp=null)},_initDrag:function(){this._lastDragOp&&this._lastDragOp.deregister&&this._lastDragOp.deregister(),this._lastDragOp=this._dragOp,this._dragOp=null},_getItem:function(e){for(;e;){if(e.classList&&e.classList.contains(t))return e;e=e.parentNode}return null},_startDrag:function(t){var r=this;r._isDragging=!1;var i,n=r._lastDragOp;if(r._didDragUpOrDown&&n instanceof g&&n.clean&&n.clean(),"up"==t.gesture.direction||"down"==t.gesture.direction){var s=t.target||t.simulatedTarget;i=r._getItem(s),i&&(i.holded||e.DomUtil.getParentOrSelfWithClass(s,o))&&(r._dragOp=new d({listEl:r.el,el:i,scrollEl:r.scrollEl,scrollView:r.scrollView,onReorder:function(e,t,i){r.onReorder&&r.onReorder(e,t,i)}}),r._dragOp.start(t),t.preventDefault(),r.isScrollFreeze=r.scrollView.freeze(!0))}else!r._didDragUpOrDown&&("left"==t.gesture.direction||"right"==t.gesture.direction)&&Math.abs(t.gesture.deltaX)>5&&(i=r._getItem(t.target),i&&i.querySelector(".item-options")&&(r._dragOp=new g({el:r.el,item:i,canSwipe:r.canSwipe}),r._dragOp.start(t),t.preventDefault(),r.isScrollFreeze=r.scrollView.freeze(!0)));n&&r._dragOp&&!r._dragOp.isSameItem(n)&&t.defaultPrevented&&n.clean&&n.clean()},_handleEndDrag:function(e){var t=this;t.scrollView&&(t.isScrollFreeze=t.scrollView.freeze(!1)),t._didDragUpOrDown=!1,t._dragOp&&t._dragOp.end(e,function(){t._initDrag()})},_handleDrag:function(e){var t=this;Math.abs(e.gesture.deltaY)>5&&(t._didDragUpOrDown=!0),t.isDragging||t._dragOp||t._startDrag(e),t._dragOp&&(e.gesture.srcEvent.preventDefault(),t._dragOp.drag(e))},_initHold:function(){var e=this;e.holdTimeout=null},_handleHold:function(e){var t=this;t._startHold(e),e.gesture.srcEvent.preventDefault()},_startHold:function(t){var r=this;e.activator.end(),r._holdOp=new a;var i=r._getItem(t.target);if(i){i.holded=!0,r._holdOp.holdedItem=i,r._holdOp.startTimer();var n=new e.CustomEvent("drag",t);n.simulatedTarget=t.target,n.gesture={},e.extend(n.gesture,t.gesture,{angle:90,deltaTime:1e3,deltaX:0,deltaY:10,distance:10,eventType:"start",direction:"up"}),n.preventDefault(),n.stopPropagation(),r._handleDrag(n)}}})}(ionic),angular.module("kunder.ionicListDraggableItem",[]).controller("ionicListDraggableItemController",["$scope","$attrs","$ionicListDelegate","$ionicHistory",function(e,t,r,i){var n=this,s=!0,l=!1,o=!1,a=r._registerInstance(n,t.delegateHandle,function(){return i.isActiveScope(e)});e.$on("$destroy",a),n.showReorder=function(e){return arguments.length&&(l=!!e),l},n.showDelete=function(e){return arguments.length&&(o=!!e),o},n.canSwipeItems=function(e){return arguments.length&&(s=!!e),s},n.closeOptionButtons=function(){n.listView&&n.listView.clearDragEffects()}}]).directive("listDraggableItem",["$timeout",function(e){function t(e){return"undefined"!=typeof e}return{restrict:"E",require:["listDraggableItem","^?$ionicScroll"],controller:"ionicListDraggableItemController",compile:function(r,i){var n=angular.element,s=n('<div class="list draggableItem">').append(r.contents()).addClass(i.type);return r.append(s),function(r,s,l,o){function a(){function l(e,t){t()&&e.addClass("visible")||e.removeClass("active"),ionic.requestAnimationFrame(function(){t()&&e.addClass("active")||e.removeClass("visible")})}var o=c.listView=new ionic.views.DraggableItemListView({el:s[0],listEl:s.children()[0],scrollEl:u&&u.element,scrollView:u&&u.scrollView,onReorder:function(t,r,i){var s=n(t).scope();s&&s.$onReorder&&e(function(){s.$onReorder(r,i)})},canSwipe:function(){return c.canSwipeItems()}});r.$on("$destroy",function(){o&&(o.deregister&&o.deregister(),o=null)}),t(i.canSwipe)&&r.$watch("!!("+i.canSwipe+")",function(e){c.canSwipeItems(e)}),t(i.showDelete)&&r.$watch("!!("+i.showDelete+")",function(e){c.showDelete(e)}),t(i.showReorder)&&r.$watch("!!("+i.showReorder+")",function(e){c.showReorder(e)}),r.$watch(function(){return c.showDelete()},function(e,t){if(e||t){e&&c.closeOptionButtons(),c.canSwipeItems(!e),s.children().toggleClass("list-left-editing",e),s.toggleClass("disable-pointer-events",e);var r=n(s[0].getElementsByClassName("item-delete"));l(r,c.showDelete)}}),r.$watch(function(){return c.showReorder()},function(e,t){if(e||t){e&&c.closeOptionButtons(),c.canSwipeItems(!e),s.children().toggleClass("list-right-editing",e);var r=n(s[0].getElementsByClassName("item-reorder"));l(r,c.showReorder)}})}var c=o[0],u=o[1];e(a)}}}}]);